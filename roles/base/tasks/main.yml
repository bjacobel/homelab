---
- name: Configure and populate apt sources
  import_tasks: apt.yml

- name: Do security setup
  import_tasks: lockdown.yml

- name: Configure avahi and daemon for .local hostnames
  import_tasks: avahi.yml

- name: Setup WiFi
  import_tasks: wifi.yml

# @TODO set up bluetooth if needed

# @TODO set up graphics adapter if needed

- name: Set hostname
  become: true
  hostname:
    name: "{{ inventory_hostname }}"
  notify:
    - Reboot

- name: Update hosts file with new hostname
  become: true
  ansible.builtin.lineinfile:
    path: /etc/hosts
    search_string: "127.0.1.1"
    line: "127.0.1.1 {{ inventory_hostname }}"
  notify:
    - Reboot

- name: Set up bash aliases
  ansible.builtin.template:
    src: ./templates/.bash_aliases
    dest: /home/{{ ansible_ssh_user }}/.bash_aliases
    mode: "0644"

- name: Disable sleep/hibernate
  become: true
  ansible.builtin.systemd:
    name: "{{ target }}"
    enabled: false
    masked: true
  loop:
    - sleep.target
    - suspend.target
    - hibernate.target
    - hybrid-sleep.target
  loop_control:
    loop_var: target

- name: Enable memory cgroup in grub
  become: true
  lineinfile:
    state: present
    path: /etc/default/grub
    line: GRUB_CMDLINE_LINUX="cgroup_enable=memory"
    backup: true
  notify:
    - Update grub
    - Reboot
