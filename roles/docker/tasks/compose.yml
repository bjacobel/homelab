- name: populate getent passwd database
  getent:
    database: passwd

- name: get user and group IDs for fs permissions
  set_fact:
    cacheable: yes
    uid: "{{ getent_passwd[user].1 }}"
    gid: "{{ getent_passwd[user].2 }}"

- name: template docker-compose.yml to ~/
  template:
    src: ./templates/docker-compose.yml
    dest: /home/{{user}}/docker-compose.yml

- name: add Caddyfile
  copy:
    src: ./templates/Caddyfile
    dest: /home/{{user}}/Caddyfile
  notify: caddy-restart

- name: start services using Compose
  community.docker.docker_compose:
    project_src: /home/{{user}}
    state: present
